{
  "openapi": "3.0.0",
  "info": {
    "title": "API Convenios Pullman",
    "version": "1.1.0",
    "description": "Documentación del backend de convenios Pullman (Enterprise)"
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "URL base (puede configurarse con SWAGGER_BASE_URL)"
    }
  ],
  "tags": [
    {
      "name": "Auth",
      "description": "Operaciones de autenticación (login, register)"
    },
    {
      "name": "Admin",
      "description": "Administración de usuarios y roles"
    },
    {
      "name": "Empresas",
      "description": "Gestión de empresas"
    },
    {
      "name": "Convenios",
      "description": "Gestión de convenios empresariales"
    },
    {
      "name": "Pasajeros",
      "description": "Gestión de pasajeros"
    },
    {
      "name": "Códigos de Descuento",
      "description": "Gestión de códigos de descuento"
    },
    {
      "name": "Descuentos",
      "description": "Gestión de reglas de descuento"
    },
    {
      "name": "Eventos",
      "description": "Gestión de eventos (viajes)"
    },
    {
      "name": "UsuarioEmpresa",
      "description": "Asignación de usuarios a empresas (Admin)"
    },
    {
      "name": "KPIs",
      "description": "Indicadores Clave de Desempeño (Solo SUPER_USUARIO)"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "AuthResponse": {
        "type": "object",
        "properties": {
          "token": {
            "type": "string"
          },
          "user": {
            "type": "object",
            "properties": {
              "id": {
                "type": "integer"
              },
              "correo": {
                "type": "string"
              },
              "rol": {
                "type": "string"
              }
            }
          },
          "message": {
            "type": "string"
          }
        }
      },
      "Empresa": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "nombre": {
            "type": "string",
            "example": "Empresa Test S.A."
          },
          "rut_empresa": {
            "type": "string",
            "example": "76.000.000-1"
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "CreateEmpresa": {
        "type": "object",
        "required": [
          "nombre",
          "rut"
        ],
        "properties": {
          "nombre": {
            "type": "string",
            "example": "Empresa Nueva S.A."
          },
          "rut": {
            "type": "string",
            "example": "12.345.678-9"
          }
        }
      },
      "UpdateEmpresa": {
        "type": "object",
        "properties": {
          "nombre": {
            "type": "string"
          },
          "rut": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": [
              "ACTIVO",
              "INACTIVO"
            ]
          }
        }
      },
      "Usuario": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "correo": {
            "type": "string",
            "example": "admin@pullman.cl"
          },
          "nombre": {
            "type": "string",
            "example": "Admin User"
          },
          "rut": {
            "type": "string",
            "example": "11.111.111-1"
          },
          "telefono": {
            "type": "string",
            "example": "+56912345678"
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "Convenio": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "nombre": {
            "type": "string",
            "example": "Convenio ABC"
          },
          "empresa_id": {
            "type": "integer",
            "example": 1
          },
          "tipo_consulta": {
            "type": "string",
            "example": "API_EXTERNA"
          },
          "endpoint": {
            "type": "string",
            "example": "http://localhost:3000/api/integraciones/araucana/validar"
          },
          "tope_monto_ventas": {
            "type": "integer",
            "example": 1000000
          },
          "tope_cantidad_tickets": {
            "type": "integer",
            "example": 50
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "Pasajero": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "rut": {
            "type": "string",
            "example": "11.111.111-1"
          },
          "nombres": {
            "type": "string",
            "example": "Juan"
          },
          "apellidos": {
            "type": "string",
            "example": "Pérez"
          },
          "fecha_nacimiento": {
            "type": "string",
            "format": "date",
            "example": "1990-01-01"
          },
          "correo": {
            "type": "string",
            "example": "juan@email.com"
          },
          "telefono": {
            "type": "string",
            "example": "+56912345678"
          },
          "tipo_pasajero_id": {
            "type": "integer",
            "example": 1
          },
          "empresa_id": {
            "type": "integer",
            "example": 1
          },
          "convenio_id": {
            "type": "integer",
            "example": 1
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "CodigoDescuento": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "codigo": {
            "type": "string",
            "example": "VERANO2026"
          },
          "convenio_id": {
            "type": "integer",
            "example": 1
          },
          "fecha_inicio": {
            "type": "string",
            "format": "date",
            "example": "2026-01-01"
          },
          "fecha_termino": {
            "type": "string",
            "format": "date",
            "example": "2026-03-01"
          },
          "max_usos": {
            "type": "integer",
            "example": 100
          },
          "usos_realizados": {
            "type": "integer",
            "example": 10
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "Descuento": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "convenio_id": {
            "type": "integer",
            "example": 1
          },
          "codigo_descuento_id": {
            "type": "integer",
            "example": null
          },
          "tipo_pasajero_id": {
            "type": "integer",
            "example": 1
          },
          "pasajero_id": {
            "type": "integer",
            "example": null
          },
          "porcentaje_descuento": {
            "type": "integer",
            "example": 15
          },
          "status": {
            "type": "string",
            "example": "ACTIVO"
          }
        }
      },
      "Evento": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 1
          },
          "tipo_evento": {
            "type": "string",
            "enum": [
              "COMPRA",
              "CAMBIO",
              "DEVOLUCION"
            ]
          },
          "tipo_pago": {
            "type": "string",
            "example": "Tarjeta de Crédito"
          },
          "ciudad_origen": {
            "type": "string",
            "example": "Santiago"
          },
          "ciudad_destino": {
            "type": "string",
            "example": "Valparaíso"
          },
          "fecha_viaje": {
            "type": "string",
            "format": "date",
            "example": "2026-02-15"
          },
          "tarifa_base": {
            "type": "integer",
            "example": 10000
          },
          "monto_pagado": {
            "type": "integer",
            "example": 8000
          },
          "porcentaje_descuento_aplicado": {
            "type": "integer",
            "example": 20
          },
          "usuario_id": {
            "type": "integer",
            "example": 1
          },
          "pasajero_id": {
            "type": "integer",
            "example": 1
          },
          "empresa_id": {
            "type": "integer",
            "example": 1
          }
        }
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/api/admin/usuarios": {
      "post": {
        "summary": "Crear usuario (solo SUPER_USUARIO) — crea `USUARIO` por defecto",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Admin"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "correo",
                  "password"
                ],
                "properties": {
                  "correo": {
                    "type": "string",
                    "example": "nuevo@pullman.cl"
                  },
                  "password": {
                    "type": "string",
                    "example": "Pass1234"
                  },
                  "rol": {
                    "type": "string",
                    "enum": [
                      "USUARIO",
                      "SUPER_USUARIO"
                    ],
                    "example": "USUARIO"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Usuario creado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer"
                    },
                    "correo": {
                      "type": "string"
                    },
                    "rol": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string",
                      "example": "Usuario creado satisfactoriamente"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "get": {
        "summary": "Listar usuarios",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          }
        ],
        "tags": [
          "Admin"
        ],
        "responses": {
          "200": {
            "description": "Lista de usuarios",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Usuario"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/admin/usuarios/{id}": {
      "get": {
        "summary": "Obtener usuario por id",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Admin"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Usuario",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Usuario"
                }
              }
            }
          },
          "404": {
            "description": "Usuario no encontrado"
          }
        }
      },
      "put": {
        "summary": "Actualizar usuario",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Admin"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "correo": {
                    "type": "string"
                  },
                  "password": {
                    "type": "string"
                  },
                  "rol": {
                    "type": "string",
                    "enum": [
                      "USUARIO",
                      "SUPER_USUARIO"
                    ]
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Usuario actualizado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Usuario"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar (soft) usuario",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Admin"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Usuario marcado como INACTIVO"
          }
        }
      }
    },
    "/api/admin/usuarios-empresas": {
      "post": {
        "summary": "Asignar un usuario a una empresa",
        "description": "Asigna un usuario existente a una empresa.\nSolo puede ser ejecutado por un SUPER_USUARIO.\nLa asignación queda auditada con el usuario creador.\n",
        "tags": [
          "UsuarioEmpresa"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "usuario_id",
                  "empresa_id"
                ],
                "properties": {
                  "usuario_id": {
                    "type": "integer",
                    "example": 5
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 2
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Usuario asignado correctamente a la empresa",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer",
                      "example": 10
                    },
                    "usuario_id": {
                      "type": "integer",
                      "example": 5
                    },
                    "empresa_id": {
                      "type": "integer",
                      "example": 2
                    },
                    "creado_por": {
                      "type": "integer",
                      "example": 1
                    },
                    "message": {
                      "type": "string",
                      "example": "Usuario asignado a la empresa correctamente"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Error de negocio (datos inválidos o relación existente)"
          },
          "401": {
            "description": "Token inválido o no enviado"
          },
          "403": {
            "description": "Acceso denegado (rol insuficiente)"
          }
        }
      }
    },
    "/api/integraciones/araucana/validar": {
      "post": {
        "summary": "Validar afiliación La Araucana",
        "description": "Consulta API externa. Si es afiliado (1001), asocia al pasajero y retorna descuentos.",
        "tags": [
          "Integraciones"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "rut"
                ],
                "properties": {
                  "rut": {
                    "type": "string",
                    "example": "12345678-9"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Consulta exitosa",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "afiliado": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "pasajero": {
                      "type": "object"
                    },
                    "empresa": {
                      "type": "string"
                    },
                    "descuentos": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "convenio": {
                            "type": "string"
                          },
                          "porcentaje": {
                            "type": "integer"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/auth/login": {
      "post": {
        "summary": "Login de usuario",
        "tags": [
          "Auth"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "correo",
                  "password"
                ],
                "properties": {
                  "correo": {
                    "type": "string",
                    "example": "admin@pullman.cl"
                  },
                  "password": {
                    "type": "string",
                    "example": "Admin1234"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login exitoso, retorna el token JWT y datos del usuario",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/auth/register": {
      "post": {
        "summary": "Registrar usuario (crea un SUPER_USUARIO por defecto)",
        "tags": [
          "Auth"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "correo",
                  "password"
                ],
                "properties": {
                  "correo": {
                    "type": "string",
                    "example": "admin@pullman.cl"
                  },
                  "password": {
                    "type": "string",
                    "example": "Admin1234"
                  },
                  "nombre": {
                    "type": "string",
                    "example": "Juan Pérez"
                  },
                  "rut": {
                    "type": "string",
                    "example": "12345678-9"
                  },
                  "telefono": {
                    "type": "string",
                    "example": 56912345678
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Registro exitoso, retorna el token JWT y datos del usuario",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/codigos-descuento": {
      "get": {
        "summary": "Listar códigos de descuento",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "convenio_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por convenio"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          },
          {
            "in": "query",
            "name": "vigentes",
            "schema": {
              "type": "string",
              "enum": [
                true,
                false
              ]
            },
            "description": "Filtrar solo códigos vigentes (activos y dentro del rango de fechas)"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de códigos de descuento",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/CodigoDescuento"
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear código de descuento (solo SUPER_USUARIO)",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "convenio_id",
                  "codigo",
                  "fecha_inicio",
                  "fecha_termino"
                ],
                "properties": {
                  "convenio_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "codigo": {
                    "type": "string",
                    "example": "VERANO2026"
                  },
                  "fecha_inicio": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-01-01"
                  },
                  "fecha_termino": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-03-31"
                  },
                  "max_usos": {
                    "type": "integer",
                    "example": 100,
                    "description": "Opcional, null = ilimitado"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Código de descuento creado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CodigoDescuento"
                }
              }
            }
          }
        }
      }
    },
    "/api/codigos-descuento/{id}": {
      "get": {
        "summary": "Obtener código de descuento por ID",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del código de descuento"
          }
        ],
        "responses": {
          "200": {
            "description": "Código de descuento encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CodigoDescuento"
                }
              }
            }
          },
          "404": {
            "description": "Código de descuento no encontrado"
          }
        }
      },
      "put": {
        "summary": "Actualizar código de descuento (solo SUPER_USUARIO)",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del código de descuento"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "fecha_inicio": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-01-01"
                  },
                  "fecha_termino": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-04-30"
                  },
                  "max_usos": {
                    "type": "integer",
                    "example": 200
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ],
                    "example": "ACTIVO"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Código de descuento actualizado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CodigoDescuento"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar código de descuento (soft delete, solo SUPER_USUARIO)",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del código de descuento"
          }
        ],
        "responses": {
          "204": {
            "description": "Código de descuento eliminado exitosamente"
          }
        }
      }
    },
    "/api/codigos-descuento/codigo/{codigo}": {
      "get": {
        "summary": "Buscar código de descuento por código",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [],
        "parameters": [
          {
            "in": "path",
            "name": "codigo",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Código del descuento",
            "example": "VERANO2026"
          }
        ],
        "responses": {
          "200": {
            "description": "Código de descuento encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/CodigoDescuento"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "descuentos": {
                          "type": "array",
                          "items": {
                            "$ref": "#/components/schemas/Descuento"
                          }
                        },
                        "convenio": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "integer"
                            },
                            "nombre": {
                              "type": "string"
                            },
                            "empresa": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "integer"
                                },
                                "nombre": {
                                  "type": "string"
                                },
                                "rut": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "404": {
            "description": "Código de descuento no encontrado"
          }
        }
      }
    },
    "/api/codigos-descuento/validar": {
      "post": {
        "summary": "Validar y usar código de descuento",
        "description": "Valida el código y si es válido, incrementa el contador de usos",
        "tags": [
          "Códigos de Descuento"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "codigo"
                ],
                "properties": {
                  "codigo": {
                    "type": "string",
                    "example": "VERANO2026"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Código válido y uso registrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CodigoDescuento"
                }
              }
            }
          },
          "400": {
            "description": "Código inválido, expirado o sin usos disponibles"
          }
        }
      }
    },
    "/api/convenios": {
      "get": {
        "description": "Retorna lista de convenios con detalles de configuración.",
        "tags": [
          "Convenios"
        ],
        "security": [],
        "parameters": [
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por empresa"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de convenios",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Convenio"
                  }
                }
              }
            }
          },
          "201": {
            "description": "Convenio creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Convenio"
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear un nuevo convenio",
        "tags": [
          "Convenios"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "nombre",
                  "empresa_id"
                ],
                "properties": {
                  "nombre": {
                    "type": "string",
                    "example": "Convenio Verano 2026"
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "tipo_consulta": {
                    "type": "string",
                    "enum": [
                      "API_EXTERNA",
                      "CODIGO_DESCUENTO"
                    ],
                    "default": "CODIGO_DESCUENTO"
                  },
                  "endpoint": {
                    "type": "string",
                    "description": "URL del servicio (Para CODIGO_DESCUENTO es auto-generado)",
                    "example": "http://localhost:3000/api/codigos-descuento/codigo/{codigo}"
                  },
                  "tope_monto_ventas": {
                    "type": "integer",
                    "example": 1000000
                  },
                  "tope_cantidad_tickets": {
                    "type": "integer",
                    "example": 50
                  }
                }
              },
              "examples": {
                "CodigoDescuento": {
                  "summary": "Convenio de Código (Default)",
                  "value": {
                    "nombre": "Convenio Verano 2026",
                    "empresa_id": 1,
                    "tipo_consulta": "CODIGO_DESCUENTO",
                    "tope_monto_ventas": 1000000,
                    "tope_cantidad_tickets": 50
                  }
                },
                "ApiExterna": {
                  "summary": "Convenio con API Externa",
                  "value": {
                    "nombre": "Convenio Araucana",
                    "empresa_id": 2,
                    "tipo_consulta": "API_EXTERNA",
                    "endpoint": "https://api.externa.com/validar",
                    "tope_monto_ventas": 5000000,
                    "tope_cantidad_tickets": 100
                  }
                }
              }
            }
          }
        },
        "responses": {
          "schema": {
            "$ref": "#/components/schemas/Convenio"
          }
        }
      }
    },
    "/api/convenios/activos": {
      "get": {
        "summary": "Listar solo convenios activos y vigentes",
        "description": "Retorna convenios que están ACTIVOS, tienen descuento ACTIVO y empresa ACTIVA.",
        "tags": [
          "Convenios"
        ],
        "parameters": [
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            }
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de convenios activos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Convenio"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/convenios/{id}": {
      "get": {
        "summary": "Obtener convenio por ID",
        "tags": [
          "Convenios"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del convenio"
          }
        ],
        "responses": {
          "200": {
            "description": "Convenio encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Convenio"
                }
              }
            }
          },
          "404": {
            "description": "Convenio no encontrado"
          }
        }
      },
      "put": {
        "summary": "Actualizar convenio",
        "tags": [
          "Convenios"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del convenio"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "nombre": {
                    "type": "string",
                    "example": "Convenio Invierno 2026"
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ],
                    "example": "ACTIVO"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Convenio actualizado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Convenio"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar convenio (soft delete)",
        "tags": [
          "Convenios"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del convenio"
          }
        ],
        "responses": {
          "204": {
            "description": "Convenio eliminado exitosamente"
          }
        }
      }
    },
    "/api/descuentos": {
      "get": {
        "summary": "Listar descuentos",
        "tags": [
          "Descuentos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "convenio_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por convenio"
          },
          {
            "in": "query",
            "name": "codigo_descuento_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por código de descuento"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de descuentos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Descuento"
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear descuento (solo SUPER_USUARIO)",
        "description": "Crea una regla de descuento para Convenio + TipoPasajero o CodigoDescuento",
        "tags": [
          "Descuentos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "porcentaje_descuento"
                ],
                "properties": {
                  "convenio_id": {
                    "type": "integer",
                    "example": 1,
                    "description": "Requerido si no se proporciona codigo_descuento_id"
                  },
                  "codigo_descuento_id": {
                    "type": "integer",
                    "example": 1,
                    "description": "Requerido si no se proporciona convenio_id"
                  },
                  "porcentaje_descuento": {
                    "type": "integer",
                    "example": 15,
                    "description": "Porcentaje entre 0 y 100"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Descuento creado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Descuento"
                }
              }
            }
          }
        }
      }
    },
    "/api/descuentos/{id}": {
      "get": {
        "summary": "Obtener descuento por ID",
        "tags": [
          "Descuentos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del descuento"
          }
        ],
        "responses": {
          "200": {
            "description": "Descuento encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Descuento"
                }
              }
            }
          },
          "404": {
            "description": "Descuento no encontrado"
          }
        }
      },
      "put": {
        "summary": "Actualizar descuento (solo SUPER_USUARIO)",
        "tags": [
          "Descuentos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del descuento"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "porcentaje_descuento": {
                    "type": "integer",
                    "example": 20,
                    "description": "Porcentaje entre 0 y 100"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ],
                    "example": "ACTIVO"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Descuento actualizado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Descuento"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar descuento (soft delete, solo SUPER_USUARIO)",
        "tags": [
          "Descuentos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del descuento"
          }
        ],
        "responses": {
          "204": {
            "description": "Descuento eliminado exitosamente"
          }
        }
      }
    },
    "/api/empresas/reportes/descuentos": {
      "get": {
        "summary": "Listar empresas con sus descuentos (Público)",
        "description": "Retorna nombre de empresa y sus porcentajes de descuento.",
        "tags": [
          "Empresas"
        ],
        "responses": {
          "200": {
            "description": "Lista simplificada de empresas y descuentos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "nombre": {
                        "type": "string",
                        "example": "Empresa Demo"
                      },
                      "descuentos": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "porcentaje_descuento": {
                              "type": "integer",
                              "example": 10
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/empresas": {
      "get": {
        "summary": "Listar todas las empresas",
        "tags": [
          "Empresas"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de registros por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          },
          {
            "in": "query",
            "name": "nombre",
            "schema": {
              "type": "string"
            },
            "description": "Buscar por nombre (exacto)"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de empresas",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": {
                        "type": "integer"
                      },
                      "nombre": {
                        "type": "string"
                      },
                      "rut_empresa": {
                        "type": "string"
                      },
                      "status": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear empresa (solo SUPER_USUARIO)",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Empresas"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "nombre",
                  "rut"
                ],
                "properties": {
                  "nombre": {
                    "type": "string",
                    "example": "Empresa Corporativa S.A."
                  },
                  "rut": {
                    "type": "string",
                    "example": "76.000.123-4"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Empresa creada correctamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer"
                    },
                    "nombre": {
                      "type": "string"
                    },
                    "rut_empresa": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/empresas/{id}": {
      "get": {
        "summary": "Obtener empresa por id",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Empresas"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Empresa",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Empresa"
                }
              }
            }
          },
          "404": {
            "description": "Empresa no encontrada"
          }
        }
      },
      "put": {
        "summary": "Actualizar empresa (solo SUPER_USUARIO)",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Empresas"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "nombre": {
                    "type": "string"
                  },
                  "rut": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Empresa actualizada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer"
                    },
                    "nombre": {
                      "type": "string"
                    },
                    "rut_empresa": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar (soft) empresa (solo SUPER_USUARIO)",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "tags": [
          "Empresas"
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Empresa marcada como INACTIVA"
          }
        }
      }
    },
    "/api/eventos/compra": {
      "post": {
        "summary": "Crear evento de compra",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "usuario_id",
                  "pasajero_id",
                  "empresa_id",
                  "ciudad_origen",
                  "ciudad_destino",
                  "fecha_viaje",
                  "tarifa_base"
                ],
                "properties": {
                  "usuario_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "pasajero_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "convenio_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "codigo_descuento_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "ciudad_origen": {
                    "type": "string",
                    "example": "Santiago"
                  },
                  "ciudad_destino": {
                    "type": "string",
                    "example": "Valparaíso"
                  },
                  "fecha_viaje": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-02-15"
                  },
                  "numero_asiento": {
                    "type": "string",
                    "example": "A12"
                  },
                  "tarifa_base": {
                    "type": "integer",
                    "example": 50000
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Evento de compra creado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Evento"
                }
              }
            }
          }
        }
      }
    },
    "/api/eventos/cambio": {
      "post": {
        "summary": "Crear evento de cambio",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "evento_origen_id",
                  "ciudad_origen",
                  "ciudad_destino",
                  "fecha_viaje",
                  "tarifa_base"
                ],
                "properties": {
                  "evento_origen_id": {
                    "type": "integer",
                    "example": 100,
                    "description": "ID del evento de compra original"
                  },
                  "usuario_id": {
                    "type": "integer",
                    "example": 1,
                    "description": "Opcional, se usa el del evento origen si no se proporciona"
                  },
                  "ciudad_origen": {
                    "type": "string",
                    "example": "Santiago"
                  },
                  "ciudad_destino": {
                    "type": "string",
                    "example": "Viña del Mar"
                  },
                  "fecha_viaje": {
                    "type": "string",
                    "format": "date",
                    "example": "2026-02-20"
                  },
                  "numero_asiento": {
                    "type": "string",
                    "example": "B15"
                  },
                  "tarifa_base": {
                    "type": "integer",
                    "example": 55000
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Evento de cambio creado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Evento"
                }
              }
            }
          }
        }
      }
    },
    "/api/eventos/devolucion": {
      "patch": {
        "summary": "Crear evento de devolución",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "evento_origen_id"
                ],
                "properties": {
                  "evento_origen_id": {
                    "type": "integer",
                    "example": 100,
                    "description": "ID del evento de compra original"
                  },
                  "usuario_id": {
                    "type": "integer",
                    "example": 1,
                    "description": "Opcional, se usa el del evento origen si no se proporciona"
                  },
                  "monto_devolucion": {
                    "type": "integer",
                    "example": 20000,
                    "description": "Opcional, se usa el monto_pagado del evento origen si no se proporciona"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Evento de devolución creado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Evento"
                }
              }
            }
          }
        }
      }
    },
    "/api/eventos": {
      "get": {
        "summary": "Listar eventos",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "tipo_evento",
            "schema": {
              "type": "string",
              "enum": [
                "COMPRA",
                "CAMBIO",
                "DEVOLUCION"
              ]
            },
            "description": "Filtrar por tipo de evento"
          },
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por empresa"
          },
          {
            "in": "query",
            "name": "pasajero_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por pasajero"
          },
          {
            "in": "query",
            "name": "convenio_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por convenio"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de eventos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "totalItems": {
                      "type": "integer"
                    },
                    "rows": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Evento"
                      }
                    },
                    "totalPages": {
                      "type": "integer"
                    },
                    "currentPage": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/eventos/{id}": {
      "get": {
        "summary": "Obtener evento por ID",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del evento"
          }
        ],
        "responses": {
          "200": {
            "description": "Evento encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Evento"
                }
              }
            }
          },
          "404": {
            "description": "Evento no encontrado"
          }
        }
      },
      "delete": {
        "summary": "Eliminar evento (soft delete)",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del evento"
          }
        ],
        "responses": {
          "204": {
            "description": "Evento eliminado exitosamente"
          }
        }
      }
    },
    "/api/eventos/pasajero/{rut}": {
      "get": {
        "summary": "Listar eventos por RUT de pasajero",
        "tags": [
          "Eventos"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "rut",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "RUT del pasajero"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de eventos del pasajero",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "totalItems": {
                      "type": "integer"
                    },
                    "rows": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Evento"
                      }
                    },
                    "totalPages": {
                      "type": "integer"
                    },
                    "currentPage": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Pasajero no encontrado"
          }
        }
      }
    },
    "/api/kpis/resumen": {
      "get": {
        "summary": "Obtener resumen de KPIs",
        "description": "Devuelve métricas agrupadas por tiempo. SUPER_USUARIO ve todo o filtra por empresa. USUARIO ve solo su empresa.",
        "tags": [
          "KPIs"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "granularidad",
            "schema": {
              "type": "string",
              "enum": [
                "diario",
                "semanal",
                "mensual",
                "trimestral",
                "semestral",
                "anual",
                "quinquenal"
              ],
              "default": "mensual"
            },
            "description": "Nivel de agrupación temporal"
          },
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por empresa (Solo SUPER_USUARIO)"
          },
          {
            "in": "query",
            "name": "fecha_inicio",
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Fecha de inicio (YYYY-MM-DD)"
          },
          {
            "in": "query",
            "name": "fecha_fin",
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Fecha de fin (YYYY-MM-DD)"
          }
        ],
        "responses": {
          "200": {
            "description": "Datos de KPIs"
          }
        }
      }
    },
    "/api/kpis/por-convenio": {
      "get": {
        "summary": "KPIs por Convenio",
        "description": "Cantidad de pasajes y monto total por convenio.",
        "tags": [
          "KPIs"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de convenios con métricas",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "convenio_id": {
                        "type": "integer"
                      },
                      "convenio_nombre": {
                        "type": "string"
                      },
                      "cantidad_pasajes": {
                        "type": "integer",
                        "description": "Cantidad Neta (Compras - Devoluciones)"
                      },
                      "total_sin_descuento": {
                        "type": "integer",
                        "description": "Monto Neto sin descuento (Tarifa Base Compras - Tarifa Base Devoluciones)"
                      },
                      "total_ventas_reales": {
                        "type": "integer",
                        "description": "Monto real pagado (Neto)"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/kpis/por-codigo": {
      "get": {
        "summary": "KPIs por Código de Descuento",
        "description": "Cantidad de pasajes y monto total por código usado.",
        "tags": [
          "KPIs"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de códigos con métricas"
          }
        }
      }
    },
    "/api/kpis/por-tipo-pasajero": {
      "get": {
        "summary": "KPIs por Tipo de Pasajero",
        "description": "Cantidad de pasajes y monto total por tipo de pasajero (Adulto, Niño, etc).",
        "tags": [
          "KPIs"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de tipos de pasajero con métricas"
          }
        }
      }
    },
    "/api/pasajeros": {
      "get": {
        "summary": "Listar pasajeros",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "empresa_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por empresa"
          },
          {
            "in": "query",
            "name": "convenio_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por convenio"
          },
          {
            "in": "query",
            "name": "tipo_pasajero_id",
            "schema": {
              "type": "integer"
            },
            "description": "Filtrar por tipo de pasajero"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "ACTIVO",
                "INACTIVO"
              ]
            },
            "description": "Filtrar por estado"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer"
            },
            "description": "Número de página"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer"
            },
            "description": "Cantidad de elementos por página"
          },
          {
            "in": "query",
            "name": "sortBy",
            "schema": {
              "type": "string"
            },
            "description": "Campo por el cual ordenar"
          },
          {
            "in": "query",
            "name": "order",
            "schema": {
              "type": "string",
              "enum": [
                "ASC",
                "DESC"
              ]
            },
            "description": "Orden de la clasificación"
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de pasajeros",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "totalItems": {
                      "type": "integer"
                    },
                    "rows": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Pasajero"
                      }
                    },
                    "totalPages": {
                      "type": "integer"
                    },
                    "currentPage": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Crear un nuevo pasajero",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "rut",
                  "nombres",
                  "apellidos",
                  "fecha_nacimiento"
                ],
                "properties": {
                  "rut": {
                    "type": "string",
                    "example": "12345678-9"
                  },
                  "nombres": {
                    "type": "string",
                    "example": "Juan"
                  },
                  "apellidos": {
                    "type": "string",
                    "example": "Pérez"
                  },
                  "fecha_nacimiento": {
                    "type": "string",
                    "format": "date",
                    "example": "1990-05-15"
                  },
                  "correo": {
                    "type": "string",
                    "example": "juan.perez@email.com"
                  },
                  "telefono": {
                    "type": "string",
                    "example": "+56912345678"
                  },
                  "tipo_pasajero_id": {
                    "type": "integer",
                    "example": 1,
                    "description": "Opcional, se calcula automáticamente por edad si no se proporciona"
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "convenio_id": {
                    "type": "integer",
                    "example": 1
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Pasajero creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Pasajero"
                }
              }
            }
          }
        }
      }
    },
    "/api/pasajeros/asociar": {
      "post": {
        "summary": "Asociar pasajero a eventos",
        "description": "Busca un pasajero por RUT, si no existe lo crea, y asocia los eventos indicados.",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "rut",
                  "eventos_ids"
                ],
                "properties": {
                  "rut": {
                    "type": "string"
                  },
                  "nombres": {
                    "type": "string"
                  },
                  "apellidos": {
                    "type": "string"
                  },
                  "fecha_nacimiento": {
                    "type": "string",
                    "format": "date"
                  },
                  "correo": {
                    "type": "string"
                  },
                  "telefono": {
                    "type": "string"
                  },
                  "empresa_id": {
                    "type": "integer"
                  },
                  "convenio_id": {
                    "type": "integer"
                  },
                  "eventos_ids": {
                    "type": "array",
                    "items": {
                      "type": "integer"
                    },
                    "description": "IDs de los eventos a asociar"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pasajero asociado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Pasajero"
                }
              }
            }
          }
        }
      }
    },
    "/api/pasajeros/{id}": {
      "get": {
        "summary": "Obtener pasajero por ID",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del pasajero"
          }
        ],
        "responses": {
          "200": {
            "description": "Pasajero encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Pasajero"
                }
              }
            }
          },
          "404": {
            "description": "Pasajero no encontrado"
          }
        }
      },
      "put": {
        "summary": "Actualizar pasajero",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del pasajero"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "nombres": {
                    "type": "string",
                    "example": "Juan Carlos"
                  },
                  "apellidos": {
                    "type": "string",
                    "example": "Pérez González"
                  },
                  "fecha_nacimiento": {
                    "type": "string",
                    "format": "date",
                    "example": "1990-05-15"
                  },
                  "correo": {
                    "type": "string",
                    "example": "juan.perez@email.com"
                  },
                  "telefono": {
                    "type": "string",
                    "example": "+56912345678"
                  },
                  "tipo_pasajero_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "empresa_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "convenio_id": {
                    "type": "integer",
                    "example": 1
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "ACTIVO",
                      "INACTIVO"
                    ],
                    "example": "ACTIVO"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pasajero actualizado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Pasajero"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Eliminar pasajero (soft delete)",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "integer"
            },
            "description": "ID del pasajero"
          }
        ],
        "responses": {
          "204": {
            "description": "Pasajero eliminado exitosamente"
          }
        }
      }
    },
    "/api/pasajeros/rut/{rut}": {
      "get": {
        "summary": "Buscar pasajero por RUT",
        "tags": [
          "Pasajeros"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "rut",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "RUT del pasajero",
            "example": "12345678-9"
          }
        ],
        "responses": {
          "200": {
            "description": "Pasajero encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Pasajero"
                }
              }
            }
          },
          "404": {
            "description": "Pasajero no encontrado"
          }
        }
      }
    }
  }
}